# 아이템 48. 스트림 병렬화는 주의해서 적용하라
자바8 부터 `parallel` 메서드만 한 번 호출하면 파이프라인을 병렬 실행할 수 있는 스트림을 지원한다. 하지만 올바르게 작성하고 사용하지 않으면 성능 개선은 커녕 프로그램이 망가질 수 있다.

## 병렬화 하기 나쁜 조건
- 데이터 소스가 `Stream.iterate`이다.
- 중간연산으로 `limit`를 사용한다.
- 종단 연산에서 수행하는 작업량이 파이프라인 전체 작업에서 상당 비중을 차지하면서 순차적인 연산이다.
- 종단 연산에서 가변축소(mutable reduction)을 수행하는 메서드를 사용한다.
  - 컬렉션을 합치는데 부담이 크다.
  - ex) `Stream`의 `collect` 메서드

종단 연산에 대해서는 아래에서도 언급한다.

## 병렬화 하기 좋은 조건
### 자료구조
- 스트림의 소스가 배열 또는 `ArrayList`, `HashMap`, `HashSet`, `ConcurrentHashMap`의 인스턴스이다.
- `int` 범위, `long` 범위이다.

위의 자료구조들은 데이터를 원하는 크기로 정확하고 손쉽게 나눌 수 있어서 일을 다수의 스레드에 분배하기 좋다는 특징이 있다. 또한 참조 지역성(locality of reference)이 뛰어나기 때문에 메인 메모리와 캐시 메모리 사이의 오버헤드가 적다.

### 종단 연산
종단 연산 중 병렬화에 가장 적합한 것은 축소(reduction)이다.
- 축소
  - 파이프라인에서 만들어진 머든 원소를 하나로 합치는 작업
  - `Stream`의 `redece`메서드 중 하나, 혹은 `min`, `max`, `count`, `sum` 같이 완성된 향태로 제공되는 메서드 중 하느를 선택해 수행
  - `anyMatch`, `allMatch`, `nonMAtch` 처럼 조건에 맞으면 바로 반환되는 메서드도 병렬화에 적합

## 병렬화의 목적
스트림 병렬화는 오직 성능 최적화 수단이다. 올바르게 사용하고 적용하더라도 파이프라인이 수행하는 진짜 작업이 병렬화에 드는 추가 비용을 상쇄하지 못한다면 성능 향상은 미미할 수 있다.

잘못된 파이프라인 하나가 시스템의 다른 부분의 성능에까지 악영향을 줄 수 있음을 유의하자.

## 병렬화의 필요성과 중요성
조건이 잘 갖춰지면 코어 수에 비례하는 성능 향상을 만끽할 수 있으나, 사실 병렬화할일이 적고 효과를 보는 일이 드물다.